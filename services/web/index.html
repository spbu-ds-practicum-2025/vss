<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Processing Web Interface</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
        h1, h2 { color: #333; }
        section { margin-bottom: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input[type="file"], input[type="text"] { padding: 10px; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { padding: 10px 15px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .task-list { margin-top: 20px; }
        .task-item { padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; }
        .task-item strong { display: block; margin-bottom: 5px; }
        .status-processing { color: #d9534f; font-weight: bold; }
        .status-completed { color: #5cb85c; font-weight: bold; }
        .status-error { color: #d9534f; font-weight: bold; }
        .download-btn { background: #5cb85c; margin-top: 10px; display: inline-block; padding: 8px 16px; color: white; text-decoration: none; border-radius: 4px; }
        .download-btn:hover { background: #4cae4c; }
        #output { margin-top: 10px; padding: 10px; background: #eef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Обработка датасетов</h1>

    <section>
        <h2>Загрузить новый файл для обработки</h2>
        <input type="file" id="file-input">
        <button id="upload-btn">Загрузить и начать обработку</button>
        <div id="upload-output"></div>
    </section>

    <section>
        <h2>Обработать файл, уже лежащий в хранилище</h2>
        <input type="text" id="file-name-input" placeholder="Например: test_words.txt или folder/data.txt">
        <button id="upload-by-name-btn">Начать обработку по имени</button>
        <div id="upload-by-name-output"></div>
    </section>

    <section>
        <h2>Мои задачи</h2>
        <p>Задачи сохраняются в браузере. Устаревшие задачи (не найденные на сервере) автоматически удаляются.</p>
        <div id="task-list" class="task-list">
            <p>Пока задач нет.</p>
        </div>
        <button id="refresh-all-btn">Обновить статус всех задач</button>
        <button id="clear-all-btn">Очистить весь список</button>
    </section>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        let tasks = JSON.parse(localStorage.getItem('processing_tasks') || '[]');

        // Добавляем счётчик 404 для каждой задачи
        tasks = tasks.map(task => ({
            ...task,
            notFoundCount: task.notFoundCount || 0
        }));

        function saveTasks() {
            localStorage.setItem('processing_tasks', JSON.stringify(tasks));
        }

        function renderTaskList() {
            const container = document.getElementById('task-list');
            if (tasks.length === 0) {
                container.innerHTML = '<p>Пока задач нет. Загрузите файл, и они появятся здесь.</p>';
                return;
            }

            container.innerHTML = '';
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `
                    <strong>Файл: ${task.filename || 'Неизвестно'}</strong>
                    <small>task_id: ${task.task_id}</small><br>
                    <span class="status-${task.status}">${getStatusText(task.status)}</span>
                    <div id="actions-${task.task_id}"></div>
                `;
                container.appendChild(div);

                const actionsDiv = document.getElementById(`actions-${task.task_id}`);

                if (task.status !== 'completed' && task.status !== 'error') {
                    const checkBtn = document.createElement('button');
                    checkBtn.textContent = 'Проверить статус';
                    checkBtn.style.marginRight = '10px';
                    checkBtn.onclick = () => checkStatus(task.task_id);
                    actionsDiv.appendChild(checkBtn);
                }

                if (task.status === 'completed') {
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `${API_BASE_URL}/files/status?task_id=${task.task_id}&download=true`;
                    downloadLink.className = 'download-btn';
                    downloadLink.textContent = 'Скачать результат';
                    downloadLink.target = '_blank';
                    actionsDiv.appendChild(downloadLink);
                }
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'processing': return 'Идёт обработка...';
                case 'completed': return 'Обработка завершена!';
                case 'error': return 'Ошибка обработки';
                default: return 'Неизвестный статус';
            }
        }

        async function addTask(task_id, filename) {
            tasks.push({ 
                task_id, 
                filename, 
                status: 'processing',
                notFoundCount: 0 
            });
            saveTasks();
            renderTaskList();
        }

        async function checkStatus(task_id) {
            const task = tasks.find(t => t.task_id === task_id);
            if (!task) return;

            try {
                const response = await fetch(`${API_BASE_URL}/files/status?task_id=${task_id}&download=false`);
                if (response.status === 404) {
                    task.notFoundCount = (task.notFoundCount || 0) + 1;
                    if (task.notFoundCount >= 3) {
                        // Автоматическое удаление устаревшей задачи
                        tasks = tasks.filter(t => t.task_id !== task_id);
                        console.log(`Задача ${task_id} удалена из списка (не найдена на сервере)`);
                    }
                } else {
                    task.notFoundCount = 0; // сбрасываем счётчик при успешном ответе
                    const data = await response.json();
                    if (data.status === 'completed' || data.status === 'error') {
                        task.status = data.status;
                    }
                }

                saveTasks();
                renderTaskList();
            } catch (err) {
                console.error('Check status error:', err);
            }
        }

        // Авто-обновление каждые 10 сек
        setInterval(() => {
            tasks.forEach(task => {
                if (task.status === 'processing') {
                    checkStatus(task.task_id);
                }
            });
        }, 10000);

        // Кнопка очистки всего списка
        document.getElementById('clear-all-btn').addEventListener('click', () => {
            if (confirm('Очистить весь список задач?')) {
                tasks = [];
                saveTasks();
                renderTaskList();
            }
        });

        // Остальной код загрузки — без изменений
        document.getElementById('upload-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('file-input');
            const output = document.getElementById('upload-output');
            if (!fileInput.files.length) {
                output.textContent = 'Выберите файл!';
                return;
            }

            output.textContent = 'Загрузка и запуск обработки...';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/files/upload`, {
                    method: 'POST',
                    body: formData
                });
                const text = await response.text();
                output.textContent = text;

                const match = text.match(/task_id: ([a-f0-9-]+)/);
                if (match) {
                    await addTask(match[1], fileInput.files[0].name);
                    fileInput.value = '';
                }
            } catch (err) {
                output.textContent = 'Ошибка: ' + err.message;
            }
        });

        document.getElementById('upload-by-name-btn').addEventListener('click', async () => {
            const nameInput = document.getElementById('file-name-input');
            const output = document.getElementById('upload-by-name-output');
            const name = nameInput.value.trim();
            if (!name) {
                output.textContent = 'Введите имя файла!';
                return;
            }

            output.textContent = 'Запуск обработки...';
            try {
                const response = await fetch(`${API_BASE_URL}/files/upload_by_name?name=${encodeURIComponent(name)}`, {
                    method: 'POST'
                });
                const text = await response.text();
                output.textContent = text;

                const match = text.match(/task_id: ([a-f0-9-]+)/);
                if (match) {
                    const filename = name.split('/').pop();
                    await addTask(match[1], filename);
                    nameInput.value = '';
                }
            } catch (err) {
                output.textContent = 'Ошибка: ' + err.message;
            }
        });

        document.getElementById('refresh-all-btn').addEventListener('click', () => {
            tasks.forEach(task => checkStatus(task.task_id));
        });

        renderTaskList();
    </script>
</body>
</html>
