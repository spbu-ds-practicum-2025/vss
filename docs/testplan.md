# План сквозного тестирования Map-Reduce Word Count

## Введение

План покрывает требования DoD (Корректный подсчет слов, Отказоустойчивость при падении Worker'а) и фокусируется на взаимодействии с внешним API.

**Общие Предусловия для всех тестов:**
- Кластер развернут (Planner, Task Manager, 3+ Worker Node).
- Внешний API (Task Manager через API Gateway) доступен.
- Для тестов с заранее подготовленными файлами: тестовые файлы загружены в хранилище S3_PW.
- Для тестов с загрузкой файлов: пользователь предоставляет файл в запросе через API Gateway.

---

## 1. Тестирование Основной Функциональности (DoD: Корректный подсчет слов)

### Тест 1.1: Успешный полный цикл Word Count с заранее подготовленным файлом

**Цель:** Проверить, что Planner корректно выполняет MapReduce и передает результат для заранее загруженного файла.

**Предусловия:**
- Используется документ `doc_small.txt` (точно 350 слов), уже загруженный в S3_PW.
- Известен эталонный результат.

**Шаги:**
1. Отправить запрос на запуск Word Count во внешний API (Task Manager), указав имя `doc_small.txt`.
2. Дождаться, пока Planner завершит обработку и вернет результат через внешний API.
3. Получить финальный результат.

**Ожидаемый результат:**
- Внешний API возвращает статус задачи: `"COMPLETED"`.
- Полученный подсчет слов точно соответствует эталонному результату.

---

### Тест 1.2: Обработка пустого документа (Краевой случай) с заранее подготовленным файлом

**Цель:** Проверить корректность обработки файла без содержимого.

**Предусловия:**
- Используется документ `doc_empty.txt` (только пробелы/знаки препинания), уже загруженный в S3_PW.

**Шаги:**
1. Отправить запрос на запуск Word Count.
2. Дождаться завершения задачи.

**Ожидаемый результат:**
- Статус задачи: `"COMPLETED"`.
- Финальный результат представляет собой пустой набор (`{}`).

---

### Тест 1.3: Комплексный сценарий с загрузкой файла (Загрузка -> Ожидание -> Получение результата)

**Цель:** Проверить полный цикл взаимодействия: загрузку файла пользователем, обработку задачи и получение результата.

**Предусловия:**
- Подготовлен тестовый файл `user_upload.txt` (например, с 500 словами; известен эталонный результат подсчета слов).
- Файл не загружен заранее в S3_PW.

**Шаги:**
1. Отправить запрос на загрузку файла через внешний API (API Gateway/Task Manager), прикрепив `user_upload.txt` в теле запроса (POST /add_file с файлом в формате txt или json).
2. Получить от API подтверждение приема задачи и идентификатор задачи (task_id).
3. Периодически запрашивать статус задачи по task_id (GET /status/{task_id}) до получения статуса `"COMPLETED"`.
4. По завершении запросить результат по task_id (GET /result/{task_id}), чтобы получить ссылку на финальный файл в S3_PW.
5. Загрузить и проверить содержимое финального файла.

**Ожидаемый результат:**
- Загрузка подтверждается, task_id возвращается.
- Статус задачи обновляется от `"PENDING"`/`"IN_PROGRESS"` до `"COMPLETED"`.
- Ссылка на результат в S3_PW предоставляется.
- Подсчет слов в финальном файле точно соответствует эталонному результату.
- Нет ошибок в процессе (например, 200 OK на всех запросах после успешной загрузки).

---

### Тест 1.4: Обработка пустого документа с загрузкой файла (Краевой случай)

**Цель:** Проверить корректность обработки пустого файла, загруженного пользователем.

**Предусловия:**
- Подготовлен пустой тестовый файл `user_empty.txt` (только пробелы/знаки препинания).

**Шаги:**
1. Отправить запрос на загрузку `user_empty.txt` через внешний API.
2. Получить task_id.
3. Запрашивать статус по task_id до `"COMPLETED"`.
4. Получить и проверить результат.

**Ожидаемый результат:**
- Статус задачи: `"COMPLETED"`.
- Финальный результат представляет собой пустой набор (`{}`).

---

## 2. Тестирование Отказоустойчивости (DoD: Выдерживать падение Worker'а)

### Тест 2.1: Восстановление после сбоя Map Worker'а

**Цель:** Убедиться, что Planner переназначает Map-задачи после падения Worker'а, и конечный результат корректен.

**Предусловия:**
- Кластер: минимум 3 Worker'а.
- Используется документ `doc_medium.txt`, уже загруженный в S3_PW.
- Известен ID Worker X.

**Шаги:**
1. Запустить Word Count.
2. Task Manager (монитор) обнаруживает сбой Worker X.
3. Planner получает уведомление, переназначает потерянные задачи.
4. Дождаться, пока Planner завершит обработку.

**Ожидаемый результат:**
- Planner успешно переназначает задачи, обеспечивая восстановление.
- Финальный статус: `"COMPLETED"`.
- Финальный результат корректен и полон.

---

### Тест 2.2: Восстановление после сбоя Reduce Worker'а

**Цель:** Проверить способность Planner'а восстановить Reduce-задачу и сохранить консистентность данных.

**Предусловия:**
- Используется большой документ (например, 100 000 уникальных слов), уже загруженный в S3_PW.
- Известен ID Worker Z, выполняющий Reduce.

**Шаги:**
1. Запустить Word Count.
2. После начала выполнения Reduce-задач, принудительно остановить Worker Z.
3. Дождаться, пока Planner завершит задачу.

**Ожидаемый результат:**
- Planner перезапускает задачи, выполнявшиеся Worker Z.
- Статус задачи: `"COMPLETED"`.
- Финальный результат содержит все ожидаемые слова.

---

## 3. Тестирование Ошибок Запуска

### Тест 3.1: Запуск задачи с несуществующим входным файлом

**Цель:** Проверить, что Planner отклоняет запуск задачи при отсутствии файла в хранилище.

**Предусловия:**
- Указано имя файла `doc_missing.txt`, который отсутствует в S3_PW.

**Шаги:**
1. Отправить запрос на запуск Word Count во внешний API.

**Ожидаемый результат:**
- Внешний API возвращает HTTP `400 Bad Request` или `404 Not Found` (ошибка инициирована Planner'ом).
- Planner не инициирует Map-задачи.
- Worker'ы не задействованы.

---

### Тест 3.2: Загрузка некорректного файла (Неподдерживаемый формат)

**Цель:** Проверить обработку ошибок при загрузке файла неподдерживаемого формата.

**Предусловия:**
- Подготовлен файл `invalid_format.pdf` (не txt или json).

**Шаги:**
1. Отправить запрос на загрузку `invalid_format.pdf` через внешний API.

**Ожидаемый результат:**
- API возвращает ошибку (например, 400 Bad Request) с сообщением о неподдерживаемом формате.
- Задача не создается, нет task_id.
- Нет обработки в Planner или Worker'ах.
